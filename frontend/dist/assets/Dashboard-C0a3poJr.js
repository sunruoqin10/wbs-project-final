import{i as P}from"./index-Bn9PLWWT.js";import{_ as Z}from"./MainLayout.vue_vue_type_script_setup_true_lang-BCk_IIN5.js";import{_ as v}from"./Card.vue_vue_type_script_setup_true_lang-pWITqjj4.js";import{_ as $}from"./Badge.vue_vue_type_script_setup_true_lang-CCLVA0ec.js";import{_ as tt}from"./ProgressBar.vue_vue_type_script_setup_true_lang-BKkjWedc.js";import{d as et,m as st,u as ot,o as nt,q as B,s as at,x as rt,y as lt,r as L,p as w,j as y,z as r,A as it,b as e,t as l,B as d,c as b,F as V,C as O,D as dt,i as T,E as ct}from"./index-BeQ_YpYi.js";import{u as ut}from"./task-pjRFF-OE.js";import{d as k}from"./dayjs.min-Do37gnd9.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./_commonjsHelpers-C4iS2aBk.js";const mt={class:"space-y-6"},ft={class:"flex items-center"},pt={class:"mt-1 text-sm text-secondary-600"},xt={class:"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4"},vt={class:"flex items-center"},gt={class:"ml-4"},ht={class:"text-2xl font-semibold text-secondary-900"},yt={class:"flex items-center"},kt={class:"ml-4"},_t={class:"text-2xl font-semibold text-secondary-900"},wt={class:"flex items-center"},bt={class:"ml-4"},Tt={class:"text-2xl font-semibold text-secondary-900"},jt={class:"flex items-center"},St={class:"ml-4"},Ct={class:"text-2xl font-semibold text-secondary-900"},Mt={class:"grid grid-cols-1 gap-6 lg:grid-cols-2"},zt={class:"flex items-center justify-between"},Dt={class:"overflow-x-auto"},It={class:"min-w-full divide-y divide-secondary-200"},Pt={class:"divide-y divide-secondary-200 bg-white"},$t={class:"whitespace-nowrap px-6 py-4"},Bt={class:"flex items-center"},Lt={class:"ml-3"},Vt={class:"whitespace-nowrap px-6 py-4"},Ot={class:"px-6 py-4"},Rt={class:"whitespace-nowrap px-6 py-4 text-sm text-secondary-600"},At={class:"space-y-3"},Nt={class:"flex items-start justify-between"},Ut={class:"flex-1"},Et={class:"font-medium text-secondary-900"},Ht={class:"mt-1 text-sm text-secondary-600"},Yt={class:"mt-3 grid grid-cols-2 gap-4 sm:grid-cols-4"},Wt={class:"flex items-center gap-2"},Ft={class:"text-sm font-medium text-secondary-900"},qt={class:"flex items-center gap-2"},Gt={class:"text-sm font-medium text-secondary-900"},Jt={class:"flex items-center gap-2"},Kt={class:"text-sm font-medium text-secondary-900"},Qt={class:"flex items-center gap-2"},de=et({__name:"Dashboard",setup(Xt){const g=st(),c=ut(),_=ot();let u=null,m=null;const j=L(),S=L(),R=w(()=>_.currentUser),h=w(()=>g.projects.slice(0,5)),A=w(()=>{const o=new Set(c.tasks.map(s=>s.id)),t=new Set(c.tasks.filter(s=>s.parentTaskId).map(s=>s.parentTaskId)),i=new Set([...o].filter(s=>!t.has(s)));return c.tasks.filter(s=>i.has(s.id)).filter(s=>s.status!=="done").sort((s,p)=>k(s.endDate).valueOf()-k(p.endDate).valueOf()).slice(0,5)}),f=w(()=>{const o=g.projects.length,t=g.projects.filter(n=>n.status==="active").length,i=g.projects.filter(n=>n.status==="completed").length,a=new Set(c.tasks.map(n=>n.id)),s=new Set(c.tasks.filter(n=>n.parentTaskId).map(n=>n.parentTaskId)),p=new Set([...a].filter(n=>!s.has(n))),x=c.tasks.filter(n=>p.has(n.id));console.log("===== Dashboard 统计调试 ====="),console.log("所有任务数量:",c.tasks.length),console.log("所有任务:",c.tasks.map(n=>({id:n.id,title:n.title,status:n.status,parentTaskId:n.parentTaskId}))),console.log("父任务ID列表:",Array.from(s)),console.log("叶子任务ID列表:",Array.from(p)),console.log("叶子任务:",x.map(n=>({id:n.id,title:n.title,status:n.status}))),console.log("待办任务数:",x.filter(n=>n.status==="todo").length),console.log("进行中任务数:",x.filter(n=>n.status==="in-progress").length),console.log("已完成任务数:",x.filter(n=>n.status==="done").length),console.log("===== 调试结束 =====");const G=x.length,J=x.filter(n=>n.status==="done").length,K=x.filter(n=>n.status==="in-progress").length,Q=x.filter(n=>n.status==="todo").length,X=_.users.length;return{totalProjects:o,activeProjects:t,completedProjects:i,totalTasks:G,completedTasks:J,inProgressTasks:K,todoTasks:Q,totalMembers:X}}),C=o=>k(o).format("YYYY-MM-DD"),N=o=>({planning:"计划中",active:"进行中",completed:"已完成","on-hold":"已暂停"})[o]||o,U=o=>({planning:"info",active:"primary",completed:"success","on-hold":"warning"})[o]||"default",E=o=>({low:"低",medium:"中",high:"高",urgent:"紧急"})[o]||o,H=o=>({low:"default",medium:"info",high:"warning",urgent:"danger"})[o]||"default",M=o=>{const t=k().startOf("day");return k(o).startOf("day").diff(t,"day")},Y=o=>{const t=M(o);return t<0?`已逾期 ${Math.abs(t)} 天`:t===0?"今天到期":t===1?"明天到期":t<=3?`剩余 ${t} 天`:t<=7?`剩余 ${t} 天`:`剩余 ${t} 天`},W=o=>{const t=M(o);return t<0||t===0?"text-danger-600":t<=3?"text-warning-600":t<=7?"text-info-600":"text-secondary-600"},F=o=>{const t=g.projectById(o);return(t==null?void 0:t.name)||o},q=o=>{if(!o)return"未分配";const t=_.users.find(i=>i.id===o);return(t==null?void 0:t.name)||"未分配"},z=()=>{if(!j.value)return;if(u&&u.dispose(),u=P(j.value),f.value.totalTasks===0){const a={title:{text:"暂无任务数据",left:"center",top:"center",textStyle:{color:"#94a3b8",fontSize:14}}};u.setOption(a);return}const o=[{value:f.value.todoTasks,name:"待办",itemStyle:{color:"#94a3b8"}},{value:f.value.inProgressTasks,name:"进行中",itemStyle:{color:"#3b82f6"}},{value:f.value.completedTasks,name:"已完成",itemStyle:{color:"#10b981"}}],t=o.reduce((a,s)=>a+s.value,0),i={tooltip:{trigger:"item",formatter:a=>{const s=t>0?Math.round(a.value/t*100):0;return`${a.name}: ${a.value} (${s}%)`}},legend:{bottom:"0%",left:"center",formatter:a=>{const s=o.find(p=>p.name===a);if(s&&s.value>0&&t>0){const p=Math.round(s.value/t*100);return`${a} ${p}%`}return a}},series:[{name:"任务状态",type:"pie",radius:["40%","70%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:20,fontWeight:"bold"}},labelLine:{show:!1},data:o}]};u.setOption(i)},D=()=>{if(!S.value)return;if(m&&m.dispose(),m=P(S.value),h.value.length===0){const t={title:{text:"暂无项目数据",left:"center",top:"center",textStyle:{color:"#94a3b8",fontSize:14}}};m.setOption(t);return}const o={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:t=>{const i=t[0],a=h.value[i.dataIndex];return`${a.name}<br/>进度: ${a.progress}%`}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:h.value.map(t=>t.name.length>6?t.name.substring(0,6)+"...":t.name),axisLabel:{interval:0,rotate:30}},yAxis:{type:"value",max:100,axisLabel:{formatter:"{value}%"}},series:[{name:"进度",type:"bar",data:h.value.map(t=>({value:t.progress||0,itemStyle:{color:t.color||"#3b82f6"}})),barWidth:"60%",label:{show:!0,position:"top",formatter:"{c}%"}}]};m.setOption(o)};nt(async()=>{await Promise.all([g.loadProjects(),c.loadTasks(),_.loadUsers()]),await B(),z(),D(),window.addEventListener("resize",I)}),at(()=>{window.removeEventListener("resize",I),u&&(u.dispose(),u=null),m&&(m.dispose(),m=null)});const I=()=>{u&&u.resize(),m&&m.resize()};return rt([()=>g.loaded,()=>c.loaded],async([o,t])=>{o&&t&&(await B(),z(),D())},{immediate:!1}),(o,t)=>{const i=it("router-link");return y(),lt(Z,null,{default:r(()=>{var a;return[e("div",mt,[e("div",ft,[e("div",null,[t[0]||(t[0]=e("h1",{class:"text-2xl font-bold text-secondary-900"},"仪表盘",-1)),e("p",pt,"欢迎回来，"+l((a=R.value)==null?void 0:a.name)+"！",1)])]),e("div",xt,[d(v,null,{default:r(()=>[e("div",vt,[t[2]||(t[2]=e("div",{class:"rounded-lg bg-primary-100 p-3"},[e("svg",{class:"h-6 w-6 text-primary-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})])],-1)),e("div",gt,[t[1]||(t[1]=e("p",{class:"text-sm font-medium text-secondary-600"},"总项目数",-1)),e("p",ht,l(f.value.totalProjects),1)])])]),_:1}),d(v,null,{default:r(()=>[e("div",yt,[t[4]||(t[4]=e("div",{class:"rounded-lg bg-accent-100 p-3"},[e("svg",{class:"h-6 w-6 text-accent-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),e("div",kt,[t[3]||(t[3]=e("p",{class:"text-sm font-medium text-secondary-600"},"进行中的项目数",-1)),e("p",_t,l(f.value.activeProjects),1)])])]),_:1}),d(v,null,{default:r(()=>[e("div",wt,[t[6]||(t[6]=e("div",{class:"rounded-lg bg-info-100 p-3"},[e("svg",{class:"h-6 w-6 text-info-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})])],-1)),e("div",bt,[t[5]||(t[5]=e("p",{class:"text-sm font-medium text-secondary-600"},"总任务数",-1)),e("p",Tt,l(f.value.totalTasks),1)])])]),_:1}),d(v,null,{default:r(()=>[e("div",jt,[t[8]||(t[8]=e("div",{class:"rounded-lg bg-warning-100 p-3"},[e("svg",{class:"h-6 w-6 text-warning-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"})])],-1)),e("div",St,[t[7]||(t[7]=e("p",{class:"text-sm font-medium text-secondary-600"},"团队成员",-1)),e("p",Ct,l(f.value.totalMembers),1)])])]),_:1})]),e("div",Mt,[d(v,null,{header:r(()=>[...t[9]||(t[9]=[e("h3",{class:"text-lg font-semibold text-secondary-900"},"任务状态分布",-1)])]),default:r(()=>[e("div",{class:"h-64",ref_key:"taskChartRef",ref:j},null,512)]),_:1}),d(v,null,{header:r(()=>[...t[10]||(t[10]=[e("h3",{class:"text-lg font-semibold text-secondary-900"},"项目进度概览",-1)])]),default:r(()=>[e("div",{class:"h-64",ref_key:"projectChartRef",ref:S},null,512)]),_:1})]),d(v,null,{header:r(()=>[e("div",zt,[t[12]||(t[12]=e("h3",{class:"text-lg font-semibold text-secondary-900"},"最近项目",-1)),d(i,{to:"/projects",class:"text-sm text-primary-600 hover:text-primary-700"},{default:r(()=>[...t[11]||(t[11]=[T(" 查看全部 ",-1)])]),_:1})])]),default:r(()=>[e("div",Dt,[e("table",It,[t[13]||(t[13]=e("thead",{class:"bg-secondary-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-secondary-500"}," 项目名称 "),e("th",{class:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-secondary-500"}," 状态 "),e("th",{class:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-secondary-500"}," 进度 "),e("th",{class:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-secondary-500"}," 截止日期 ")])],-1)),e("tbody",Pt,[(y(!0),b(V,null,O(h.value,s=>(y(),b("tr",{key:s.id,class:"hover:bg-secondary-50"},[e("td",$t,[e("div",Bt,[e("div",{class:"h-2.5 w-2.5 rounded-full",style:dt({backgroundColor:s.color||"#3b82f6"})},null,4),e("div",Lt,[d(i,{to:`/projects/${s.id}`,class:"text-sm font-medium text-secondary-900 hover:text-primary-600"},{default:r(()=>[T(l(s.name),1)]),_:2},1032,["to"])])])]),e("td",Vt,[d($,{variant:U(s.status)},{default:r(()=>[T(l(N(s.status)),1)]),_:2},1032,["variant"])]),e("td",Ot,[d(tt,{value:s.progress},null,8,["value"])]),e("td",Rt,l(C(s.endDate)),1)]))),128))])])])]),_:1}),d(v,null,{header:r(()=>[...t[14]||(t[14]=[e("h3",{class:"text-lg font-semibold text-secondary-900"},"即将到期的任务",-1)])]),default:r(()=>[e("div",At,[(y(!0),b(V,null,O(A.value,s=>(y(),b("div",{key:s.id,class:"rounded-lg border border-secondary-200 p-4 hover:bg-secondary-50"},[e("div",Nt,[e("div",Ut,[e("p",Et,l(s.title),1),e("p",Ht,l(F(s.projectId)),1)]),d($,{variant:H(s.priority),class:"ml-3"},{default:r(()=>[T(l(E(s.priority)),1)]),_:2},1032,["variant"])]),e("div",Yt,[e("div",Wt,[t[16]||(t[16]=e("svg",{class:"h-4 w-4 text-secondary-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)),e("div",null,[t[15]||(t[15]=e("p",{class:"text-xs text-secondary-500"},"开始时间",-1)),e("p",Ft,l(C(s.startDate)),1)])]),e("div",qt,[t[18]||(t[18]=e("svg",{class:"h-4 w-4 text-secondary-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),e("div",null,[t[17]||(t[17]=e("p",{class:"text-xs text-secondary-500"},"结束时间",-1)),e("p",Gt,l(C(s.endDate)),1)])]),e("div",Jt,[t[20]||(t[20]=e("svg",{class:"h-4 w-4 text-secondary-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})],-1)),e("div",null,[t[19]||(t[19]=e("p",{class:"text-xs text-secondary-500"},"负责人",-1)),e("p",Kt,l(q(s.assigneeId)),1)])]),e("div",Qt,[t[22]||(t[22]=e("svg",{class:"h-4 w-4 text-secondary-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),e("div",null,[t[21]||(t[21]=e("p",{class:"text-xs text-secondary-500"},"剩余时间",-1)),e("span",{class:ct([W(s.endDate),"text-xs font-medium"])},l(Y(s.endDate)),3)])])])]))),128))])]),_:1})])]}),_:1})}}});export{de as default};
