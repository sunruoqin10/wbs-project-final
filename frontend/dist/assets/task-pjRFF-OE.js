import{bW as q,r as T,l}from"./index-BeQ_YpYi.js";const z=[{id:"t1",projectId:"p1",title:"需求分析与设计",description:"完成电商平台的功能需求分析和技术架构设计。",status:"done",priority:"high",assigneeId:"u1",startDate:"2024-01-01",endDate:"2024-01-15",estimatedHours:40,actualHours:38,progress:100,dependencies:[],tags:["需求","设计"],attachments:[],comments:[],createdAt:"2023-12-20",updatedAt:"2024-01-15"},{id:"t2",projectId:"p1",title:"数据库设计与实现",description:"设计数据库结构，创建表结构和索引。",status:"done",priority:"high",assigneeId:"u5",startDate:"2024-01-10",endDate:"2024-01-25",estimatedHours:60,actualHours:55,progress:100,dependencies:["t1"],tags:["数据库","后端"],attachments:[],comments:[],createdAt:"2024-01-05",updatedAt:"2024-01-25"},{id:"t3",projectId:"p1",title:"用户认证系统",description:"实现用户注册、登录、密码找回等功能。",status:"done",priority:"high",assigneeId:"u3",startDate:"2024-01-20",endDate:"2024-02-10",estimatedHours:80,actualHours:75,progress:100,dependencies:["t2"],tags:["认证","后端"],attachments:[],comments:[],createdAt:"2024-01-15",updatedAt:"2024-02-10"},{id:"t4",projectId:"p1",title:"商品管理模块",description:"实现商品的增删改查、分类管理、库存管理等功能。",status:"in-progress",priority:"high",assigneeId:"u3",startDate:"2024-02-01",endDate:"2024-03-15",estimatedHours:120,actualHours:90,progress:75,dependencies:["t3"],tags:["商品","后端","前端"],attachments:[],comments:[],createdAt:"2024-01-25",updatedAt:"2024-05-10"},{id:"t5",projectId:"p1",title:"购物车功能",description:"实现购物车添加、删除、修改数量等功能。",status:"in-progress",priority:"medium",assigneeId:"u3",startDate:"2024-03-01",endDate:"2024-03-31",estimatedHours:60,actualHours:40,progress:65,dependencies:["t4"],tags:["购物车","前端"],attachments:[],comments:[],createdAt:"2024-02-20",updatedAt:"2024-05-10"},{id:"t6",projectId:"p1",title:"订单系统",description:"实现订单创建、支付、物流跟踪等功能。",status:"in-progress",priority:"high",assigneeId:"u5",startDate:"2024-03-15",endDate:"2024-05-15",estimatedHours:150,actualHours:85,progress:55,dependencies:["t5"],tags:["订单","后端"],attachments:[],comments:[],createdAt:"2024-03-01",updatedAt:"2024-05-10"},{id:"t7",projectId:"p1",title:"支付接口集成",description:"集成支付宝、微信支付等支付方式。",status:"todo",priority:"high",assigneeId:"u5",startDate:"2024-05-01",endDate:"2024-05-31",estimatedHours:80,actualHours:0,progress:0,dependencies:["t6"],tags:["支付","第三方"],attachments:[],comments:[],createdAt:"2024-04-15",updatedAt:"2024-05-01"},{id:"t8",projectId:"p1",title:"后台管理系统",description:"开发电商平台后台管理界面。",status:"todo",priority:"medium",assigneeId:"u1",startDate:"2024-05-15",endDate:"2024-06-30",estimatedHours:100,actualHours:0,progress:0,dependencies:["t4","t6"],tags:["后台","前端"],attachments:[],comments:[],createdAt:"2024-04-20",updatedAt:"2024-05-01"},{id:"t9",projectId:"p2",title:"网站原型设计",description:"完成官网各页面的线框图和交互原型设计。",status:"done",priority:"high",assigneeId:"u4",startDate:"2024-03-01",endDate:"2024-03-15",estimatedHours:40,actualHours:42,progress:100,dependencies:[],tags:["设计","原型"],attachments:[],comments:[],createdAt:"2024-02-25",updatedAt:"2024-03-15"},{id:"t10",projectId:"p2",title:"UI视觉设计",description:"完成官网的视觉设计，包括配色、图标、插画等。",status:"done",priority:"high",assigneeId:"u4",startDate:"2024-03-10",endDate:"2024-03-31",estimatedHours:60,actualHours:58,progress:100,dependencies:["t9"],tags:["设计","UI"],attachments:[],comments:[],createdAt:"2024-03-05",updatedAt:"2024-03-31"},{id:"t11",projectId:"p2",title:"首页开发",description:"开发官网首页，实现响应式布局和动画效果。",status:"done",priority:"high",assigneeId:"u2",startDate:"2024-03-20",endDate:"2024-04-10",estimatedHours:50,actualHours:48,progress:100,dependencies:["t10"],tags:["前端","首页"],attachments:[],comments:[],createdAt:"2024-03-15",updatedAt:"2024-04-10"},{id:"t12",projectId:"p2",title:"关于我们页面",description:"开发关于我们页面，展示公司介绍、团队成员等信息。",status:"done",priority:"medium",assigneeId:"u2",startDate:"2024-04-01",endDate:"2024-04-15",estimatedHours:30,actualHours:28,progress:100,dependencies:["t11"],tags:["前端"],attachments:[],comments:[],createdAt:"2024-03-25",updatedAt:"2024-04-15"},{id:"t13",projectId:"p2",title:"产品服务页面",description:"开发产品服务展示页面。",status:"in-progress",priority:"medium",assigneeId:"u2",startDate:"2024-04-10",endDate:"2024-04-30",estimatedHours:40,actualHours:25,progress:60,dependencies:["t11"],tags:["前端"],attachments:[],comments:[],createdAt:"2024-04-05",updatedAt:"2024-05-10"},{id:"t14",projectId:"p2",title:"联系我们页面",description:"开发联系页面，包含表单和地图。",status:"todo",priority:"low",assigneeId:"u2",startDate:"2024-05-01",endDate:"2024-05-15",estimatedHours:25,actualHours:0,progress:0,dependencies:["t13"],tags:["前端"],attachments:[],comments:[],createdAt:"2024-04-20",updatedAt:"2024-05-01"},{id:"t15",projectId:"p3",title:"技术方案调研",description:"调研移动端开发技术方案，选择合适的框架。",status:"done",priority:"high",assigneeId:"u1",startDate:"2024-05-01",endDate:"2024-05-10",estimatedHours:30,actualHours:32,progress:100,dependencies:[],tags:["调研","技术"],attachments:[],comments:[],createdAt:"2024-05-01",updatedAt:"2024-05-10"},{id:"t16",projectId:"p3",title:"UI设计规范",description:"制定移动端UI设计规范和组件库。",status:"in-progress",priority:"high",assigneeId:"u4",startDate:"2024-05-05",endDate:"2024-05-25",estimatedHours:50,actualHours:30,progress:60,dependencies:["t15"],tags:["设计"],attachments:[],comments:[],createdAt:"2024-05-03",updatedAt:"2024-05-10"},{id:"t17",projectId:"p3",title:"项目架构搭建",description:"搭建移动端项目基础架构。",status:"todo",priority:"high",assigneeId:"u1",startDate:"2024-05-20",endDate:"2024-06-10",estimatedHours:60,actualHours:0,progress:0,dependencies:["t15"],tags:["架构","开发"],attachments:[],comments:[],createdAt:"2024-05-10",updatedAt:"2024-05-10"},{id:"t18",projectId:"p4",title:"数据采集模块",description:"实现数据采集和ETL功能。",status:"done",priority:"high",assigneeId:"u3",startDate:"2023-10-01",endDate:"2023-11-15",estimatedHours:100,actualHours:95,progress:100,dependencies:[],tags:["ETL","后端"],attachments:[],comments:[],createdAt:"2023-09-20",updatedAt:"2023-11-15"},{id:"t19",projectId:"p4",title:"数据存储设计",description:"设计数据仓库架构和存储方案。",status:"done",priority:"high",assigneeId:"u3",startDate:"2023-10-15",endDate:"2023-11-30",estimatedHours:80,actualHours:85,progress:100,dependencies:["t18"],tags:["数据仓库"],attachments:[],comments:[],createdAt:"2023-10-10",updatedAt:"2023-11-30"},{id:"t20",projectId:"p4",title:"可视化组件开发",description:"开发图表组件和仪表盘。",status:"done",priority:"high",assigneeId:"u6",startDate:"2023-11-01",endDate:"2024-01-15",estimatedHours:120,actualHours:115,progress:100,dependencies:["t19"],tags:["可视化","前端"],attachments:[],comments:[],createdAt:"2023-10-25",updatedAt:"2024-01-15"},{id:"t21",projectId:"p4",title:"报表生成功能",description:"实现自定义报表生成和导出功能。",status:"done",priority:"medium",assigneeId:"u6",startDate:"2024-01-01",endDate:"2024-03-15",estimatedHours:100,actualHours:98,progress:100,dependencies:["t20"],tags:["报表"],attachments:[],comments:[],createdAt:"2023-12-20",updatedAt:"2024-03-15"},{id:"t22",projectId:"p5",title:"需求调研",description:"调研各部门的管理需求。",status:"done",priority:"medium",assigneeId:"u1",startDate:"2024-02-01",endDate:"2024-02-20",estimatedHours:40,actualHours:38,progress:100,dependencies:[],tags:["需求"],attachments:[],comments:[],createdAt:"2024-01-20",updatedAt:"2024-02-20"},{id:"t23",projectId:"p5",title:"人事管理模块",description:"开发人事管理功能，包括员工信息、考勤等。",status:"done",priority:"high",assigneeId:"u5",startDate:"2024-02-15",endDate:"2024-03-31",estimatedHours:80,actualHours:75,progress:100,dependencies:["t22"],tags:["人事","后端"],attachments:[],comments:[],createdAt:"2024-02-10",updatedAt:"2024-03-31"},{id:"t24",projectId:"p5",title:"财务管理模块",description:"开发财务管理功能，包括报销、预算等。",status:"in-progress",priority:"high",assigneeId:"u5",startDate:"2024-03-15",endDate:"2024-05-30",estimatedHours:100,actualHours:60,progress:60,dependencies:["t23"],tags:["财务","后端"],attachments:[],comments:[],createdAt:"2024-03-10",updatedAt:"2024-05-10"},{id:"t25",projectId:"p6",title:"客服聊天系统",description:"开发在线客服聊天功能。",status:"done",priority:"high",assigneeId:"u3",startDate:"2024-04-01",endDate:"2024-04-30",estimatedHours:100,actualHours:95,progress:100,dependencies:[],tags:["聊天","WebSocket"],attachments:[],comments:[],createdAt:"2024-03-25",updatedAt:"2024-04-30"},{id:"t26",projectId:"p6",title:"工单系统",description:"开发工单创建、分配、处理、关闭流程。",status:"in-progress",priority:"high",assigneeId:"u3",startDate:"2024-04-15",endDate:"2024-06-15",estimatedHours:120,actualHours:65,progress:55,dependencies:["t25"],tags:["工单","后端"],attachments:[],comments:[],createdAt:"2024-04-10",updatedAt:"2024-05-10"},{id:"t27",projectId:"p6",title:"知识库功能",description:"开发客服知识库功能，支持常见问题查询。",status:"in-progress",priority:"medium",assigneeId:"u2",startDate:"2024-05-01",endDate:"2024-06-01",estimatedHours:60,actualHours:30,progress:50,dependencies:[],tags:["知识库","前端"],attachments:[],comments:[],createdAt:"2024-04-25",updatedAt:"2024-05-10"},{id:"t28",projectId:"p6",title:"客服数据统计",description:"开发客服工作统计和报表功能。",status:"todo",priority:"medium",assigneeId:"u6",startDate:"2024-06-01",endDate:"2024-07-15",estimatedHours:50,actualHours:0,progress:0,dependencies:["t26","t27"],tags:["统计","报表"],attachments:[],comments:[],createdAt:"2024-05-15",updatedAt:"2024-05-15"}],K=q("task",()=>{const n=T([]),u=T(null),A=T(!1),w=T(!1),$=async t=>{try{A.value=!0;const e=await l.getTasks(t);n.value=e.filter(a=>a!=null),j(),S(),await y(),await x(),w.value=!0}catch(e){console.warn("API 未连接，使用 mock 数据:",e),n.value=z,j(),S(),await y(),await x(),w.value=!0}finally{A.value=!1}},y=async()=>{const t=new Set;n.value.forEach(e=>{e&&e.parentTaskId&&t.add(e.parentTaskId)});for(const e of t)await f(e),await h(e)},j=()=>{n.value=n.value.map(t=>t&&t.status==="todo"&&t.progress!==0?{...t,progress:0}:t)},S=()=>{n.value=n.value.map(t=>t&&t.status==="done"&&t.progress!==100?{...t,progress:100}:t)},k=async t=>{var I;const e=m(t);if(e.length===0)return;const a=e.map(g=>new Date(g.startDate).getTime()),s=e.map(g=>new Date(g.endDate).getTime()),i=new Date(Math.min(...a)),r=new Date(Math.max(...s)),o=i.toISOString().split("T")[0],d=r.toISOString().split("T")[0],c=n.value.findIndex(g=>g&&g.id===t);if(c===-1)return;const p=n.value[c];if(p&&!(p.startDate===o&&p.endDate===d))try{const g={...p,startDate:o,endDate:d};n.value[c]=g,((I=u.value)==null?void 0:I.id)===t&&(u.value=g),await l.updateTask(t,{startDate:o,endDate:d}),p.parentTaskId&&await k(p.parentTaskId)}catch(g){console.error("Failed to update parent task dates:",g)}},v=async t=>{var o;const e=m(t);if(e.length===0)return;const a=e.reduce((d,c)=>d+(c.estimatedHours||0),0),s=e.reduce((d,c)=>d+(c.actualHours||0),0),i=n.value.findIndex(d=>d&&d.id===t);if(i===-1)return;const r=n.value[i];if(r&&!(r.estimatedHours===a&&r.actualHours===s))try{const d={...r,estimatedHours:a,actualHours:s};n.value[i]=d,((o=u.value)==null?void 0:o.id)===t&&(u.value=d),await l.updateTask(t,{estimatedHours:a,actualHours:s}),r.parentTaskId&&await v(r.parentTaskId)}catch(d){console.error("Failed to update parent task hours:",d)}},x=async()=>{const t=new Set;n.value.forEach(e=>{e&&e.parentTaskId&&t.add(e.parentTaskId)});for(const e of t)await k(e)},E=t=>n.value.filter(e=>e&&e.projectId===t),B=t=>n.value.filter(e=>e&&e.status===t),M=t=>n.value.filter(e=>e&&e.assigneeId===t),H=t=>n.value.find(e=>e&&e.id===t),m=t=>n.value.filter(e=>e&&e.parentTaskId===t),P=(t,e=0)=>{const a=H(t);return!a||!a.parentTaskId?e:P(a.parentTaskId,e+1)},D=t=>{const e=m(t);let a=[...e];return e.forEach(s=>{const i=D(s.id);a=[...a,...i]}),a},b=t=>{const e=D(t);if(e.length===0){const s=H(t);return(s==null?void 0:s.progress)||0}const a=e.reduce((s,i)=>s+i.progress,0);return Math.round(a/e.length)},U=t=>{const e=m(t),a=D(t),s=a.filter(o=>o.status==="done").length,i=a.filter(o=>o.status==="in-progress").length,r=a.filter(o=>o.status==="todo").length;return{total:e.length,completed:s,inProgress:i,todo:r,aggregatedProgress:b(t),totalDescendants:a.length}},C=async t=>{try{const e=await l.createTask(t);return e?(n.value.unshift(e),e.parentTaskId&&(await f(e.parentTaskId),await h(e.parentTaskId),await k(e.parentTaskId),(e.estimatedHours||e.actualHours)&&await v(e.parentTaskId))):console.warn("Created task is null, not adding to list"),e}catch(e){throw console.error("Failed to create task:",e),e}},L=async(t,e)=>{var a;try{const s=H(t),i=s==null?void 0:s.parentTaskId,r=s==null?void 0:s.estimatedHours,o=s==null?void 0:s.actualHours,d=await l.updateTask(t,e);if(d){const c=n.value.findIndex(I=>I&&I.id===t);c!==-1&&(n.value[c]=d),((a=u.value)==null?void 0:a.id)===t&&(u.value=d);const p=d.parentTaskId||i;p&&(await f(p),await h(p),await k(p),(e.estimatedHours!==void 0||e.actualHours!==void 0)&&await v(p))}return d}catch(s){throw console.error("Failed to update task:",s),s}},O=async t=>{var e;try{console.log("===== 开始删除任务 ====="),console.log("删除任务 ID:",t),console.log("删除前的任务列表:",n.value.map(r=>r?`${r.id}: ${r.title}`:"null"));const a=n.value.findIndex(r=>r&&r.id===t),s=a!==-1?n.value[a]:null,i=s==null?void 0:s.parentTaskId;if(await l.deleteTask(t),console.log("API 删除成功"),a!==-1){const r=n.value[a];n.value.splice(a,1),console.log("从列表中移除任务:",r)}else console.warn("任务在列表中未找到");((e=u.value)==null?void 0:e.id)===t&&(u.value=null),console.log("删除后的任务列表:",n.value.map(r=>r?`${r.id}: ${r.title}`:"null")),console.log("===== 删除任务完成 ====="),i&&(await f(i),await h(i),await k(i),(s!=null&&s.estimatedHours||s!=null&&s.actualHours)&&await v(i))}catch(a){throw console.error("Failed to delete task:",a),a}},W=async(t,e)=>{var i,r;const a=n.value.findIndex(o=>o&&o.id===t);if(a===-1){console.warn(`Task with id ${t} not found`);return}const s=n.value[a];if(!s){console.warn(`Task at index ${a} is null`);return}if(s.status!==e)try{const o={status:e};e==="todo"?o.progress=0:e==="done"&&(o.progress=100),n.value[a]={...s,...o},((i=u.value)==null?void 0:i.id)===t&&(u.value={...u.value,...o});const d=await l.updateTaskStatus(t,e);e==="todo"&&await l.updateTaskProgress(t,0),e==="done"&&await l.updateTaskProgress(t,100);let c=d;d&&(d.status==="todo"?c={...d,progress:0}:d.status==="done"&&(c={...d,progress:100}));const p=n.value.findIndex(I=>I&&I.id===t);p!==-1&&c&&(n.value[p]=c),((r=u.value)==null?void 0:r.id)===t&&c&&(u.value=c),s.parentTaskId&&(await f(s.parentTaskId),await h(s.parentTaskId))}catch(o){console.error("Failed to update task status:",o)}},Z=async(t,e)=>{var i,r;const a=n.value.findIndex(o=>o&&o.id===t);if(a===-1){console.warn(`Task with id ${t} not found`);return}const s=n.value[a];if(!s){console.warn(`Task at index ${a} is null`);return}if(s.progress!==e)try{n.value[a]={...s,progress:e},((i=u.value)==null?void 0:i.id)===t&&(u.value={...u.value,progress:e});const o=await l.updateTaskProgress(t,e),d=n.value.findIndex(c=>c&&c.id===t);d!==-1&&o&&(n.value[d]=o),((r=u.value)==null?void 0:r.id)===t&&o&&(u.value=o),s.parentTaskId&&(await f(s.parentTaskId),await h(s.parentTaskId))}catch(o){console.error("Failed to update task progress:",o)}},f=async t=>{var o;const e=m(t);if(e.length===0)return;const a=e.reduce((d,c)=>d+(c.progress||0),0),s=Math.round(a/e.length),i=n.value.findIndex(d=>d&&d.id===t);if(i===-1)return;const r=n.value[i];if(!(!r||r.progress===s))try{n.value[i]={...r,progress:s},((o=u.value)==null?void 0:o.id)===t&&(u.value={...u.value,progress:s}),await l.updateTaskProgress(t,s),r.parentTaskId&&await f(r.parentTaskId)}catch(d){console.error("Failed to update parent task progress:",d)}},F=t=>{const e=m(t);if(e.length===0)return"todo";const a=e.map(r=>r.status);if(a.every(r=>r==="done"))return"done";if(a.some(r=>r==="in-progress"))return"in-progress";const s=a.some(r=>r==="todo"),i=a.some(r=>r==="done");return s&&i?"in-progress":"todo"},h=async t=>{var r;if(m(t).length===0)return;const a=F(t),s=n.value.findIndex(o=>o&&o.id===t);if(s===-1)return;const i=n.value[s];if(!(!i||i.status===a))try{n.value[s]={...i,status:a},((r=u.value)==null?void 0:r.id)===t&&(u.value={...u.value,status:a}),await l.updateTaskStatus(t,a),i.parentTaskId&&await h(i.parentTaskId)}catch(o){console.error("Failed to update parent task status:",o)}};return{tasks:n,currentTask:u,loading:A,loaded:w,loadTasks:$,tasksByProject:E,tasksByStatus:B,tasksByAssignee:M,getTaskById:H,getSubtasks:m,getTaskDepth:P,getAllDescendants:D,computeAggregatedProgress:b,getSubtaskSummary:U,createTask:C,updateTask:L,deleteTask:O,updateTaskStatus:W,updateTaskProgress:Z,updateParentTaskProgress:f,updateParentTaskStatus:h,updateParentTaskDates:k,updateParentTaskHours:v,computeParentTaskStatus:F,setCurrentTask:t=>{u.value=t}}});export{K as u};
